<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="PDF操作去除页脚部位的水印">
<meta property="og:type" content="article">
<meta property="og:title" content="PDF操作">
<meta property="og:url" content="https://zuoluo11.github.io/2018/06/11/PDF操作/index.html">
<meta property="og:site_name" content="菜儿's BLog">
<meta property="og:description" content="PDF操作去除页脚部位的水印">
<meta property="og:image" content="https://zuoluo11.github.io/2018/06/11/PDF操作/20180611152915.jpg">
<meta property="og:updated_time" content="2018-06-15T00:41:13.563Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PDF操作">
<meta name="twitter:description" content="PDF操作去除页脚部位的水印">
<meta name="twitter:image" content="https://zuoluo11.github.io/2018/06/11/PDF操作/20180611152915.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zuoluo11.github.io/2018/06/11/PDF操作/"/>





  <title>PDF操作 | 菜儿's BLog</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-89372867-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?44133fc659a5df81af97508f6de6baeb";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">菜儿's BLog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Remember Yourself.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://zuoluo11.github.io/2018/06/11/PDF操作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="菜儿">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="菜儿's BLog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">PDF操作</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-11T14:36:07+08:00">
                2018-06-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/插件/" itemprop="url" rel="index">
                    <span itemprop="name">插件</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>PDF操作去除页脚部位的水印</p>
<a id="more"></a>
<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>使用某报表插件时，由于免费版导出PDF会出现水印字体，因此考虑将该水印去除后，输出到客户端浏览器。<br><img src="/2018/06/11/PDF操作/20180611152915.jpg" alt="页脚位置出现水印" title="页脚位置出现水印"></p>
<p>考虑的解决方案包括：<br>1、 报表插件导出PDF -&gt;编辑PDF水印-&gt;PDF输出到客户端。<br>2、 报表插件导出图片-&gt;编程处理图片水印-&gt;将多张图片生成PDF-&gt;PDF输出到客户端。<br>3、 寻找破解版的报表插件直接导出PDF。<br>4、 自己通过代码直接生成Word，不使用第三方报表插件。</p>
<p>OK上面就是能够想到的解决方法。</p>
<p>第4种方案应该可以实现，但相对来说工作量大一些，放到最后尝试，所以没有使用。<br>第3种方案简单粗暴，但在实现过程中发现第三方报表插件的版本5.6虽然有破解版，但由于版本过低，导致页面只能在<br>低版本的IE中才能查看，明显无法用于实际环境。<br>第2种方案虽然比直接操作PDF复杂一些，但是肯定能实现，在实现的过程中发现，报表插件导出的图片IMG中会存在分页内容，所以暂时放弃。（后期发现可以导出多张图片）<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">String visitGUID=Guid.NewGuid().ToString();</div><div class="line">IGRExportOption ExportOption = Report.PrepareExport(GRExportType.gretIMG);</div><div class="line">IGRE2IMGOption E2IMGOption = ExportOption.AsE2IMGOption;</div><div class="line">E2IMGOption.ImageType = GRExportImageType.greitPNG;</div><div class="line">E2IMGOption.AllInOne = <span class="literal">false</span>; <span class="comment">//所有页产生在一个图像文件中</span></div><div class="line">E2IMGOption.FileName = ReportPath + <span class="string">"\\SuperviseExamine\\Result\\"</span> + visitGUID + <span class="string">"\\"</span> + visitGUID + <span class="string">".png"</span>;</div><div class="line">Report.Export();</div></pre></td></tr></table></figure></p>
<p>最后留下第1种方案并开始进行尝试实现。</p>
<h2 id="收集网上信息"><a href="#收集网上信息" class="headerlink" title="收集网上信息"></a>收集网上信息</h2><p>对PDF操作肯定找第三方控件了，iText上场。</p>
<h3 id="PDF操作插件-iText"><a href="#PDF操作插件-iText" class="headerlink" title="PDF操作插件 iText"></a>PDF操作插件 iText</h3><p>iText is a PDF library that allows you to CREATE, ADAPT, INSPECT and MAINTAIN documents in the Portable Document Format (PDF), allowing you to add PDF functionality to your software projects with ease.  We even have documentation to help you get coding.</p>
<p>We have two currently supported versions: iText 5 and iText 7. Both are available under AGPL and Commercial license.</p>
<ul>
<li>iText 5 AGPL</li>
<li>iText 7 community: <a href="https://www.nuget.org/packages/itext7/" target="_blank" rel="external">https://www.nuget.org/packages/itext7/</a></li>
</ul>
<p>iText 5 is a one solution library that is complex, but well documented to help you create your solutions.</p>
<p>iText 7 is a complete re-write of iText 5, allowing you to choose your adventure with add-ons, all based on a simple, modular code structure that is easy to use and well documented.</p>
<p>本次使用iText5插件，版本号5.5.13</p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h3 id="最终实现代码"><a href="#最终实现代码" class="headerlink" title="最终实现代码"></a>最终实现代码</h3><p>方便找到这篇文章的朋友，直接将实现的代码放出<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> ServerUtility</div><div class="line">   &#123;</div><div class="line">       <span class="comment">//直接使用流对象进行数据处理</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ResponseBinaryPDF</span><span class="params">(HttpContextBase context, IGRBinaryObject ExportResult, <span class="built_in">string</span> FileName, <span class="built_in">string</span> ContentType, <span class="built_in">string</span> OpenMode)</span></span></div><div class="line">       &#123;</div><div class="line">           <span class="comment">//通过已有PDF来修改水印</span></div><div class="line">           <span class="comment">//using (FileStream fs = new FileStream(outputFilePath, FileMode.Open))</span></div><div class="line">           <span class="comment">//&#123;</span></div><div class="line">           <span class="comment">//    byte[] bytes = new byte[(int)fs.Length];</span></div><div class="line">           <span class="comment">//    fs.Read(bytes, 0, bytes.Length);</span></div><div class="line">           <span class="comment">//    fs.Close();</span></div><div class="line">           <span class="comment">//&#125;</span></div><div class="line"></div><div class="line">           byte[] inputPdfStreamData = (byte[])(ExportResult.SaveToVariant());<span class="comment">//PDF字节流</span></div><div class="line"></div><div class="line">           <span class="keyword">using</span> (MemoryStream outputPdfStream = <span class="keyword">new</span> MemoryStream())</div><div class="line">           &#123;</div><div class="line">               <span class="comment">//使用PDF字节数组初始化PDFReader</span></div><div class="line">               PdfReader reader = <span class="keyword">new</span> PdfReader(inputPdfStreamData);</div><div class="line">               <span class="comment">//按照原PDF的内容创建PdfStamper对象，准备放一张白色图片去掉水印</span></div><div class="line">               <span class="keyword">using</span> (PdfStamper stamper = <span class="keyword">new</span> PdfStamper(reader, outputPdfStream))</div><div class="line">               &#123;</div><div class="line">                   <span class="keyword">int</span> pageCount = reader.NumberOfPages;</div><div class="line">                   <span class="comment">//多页循环</span></div><div class="line">                   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= pageCount; i++)</div><div class="line">                   &#123;</div><div class="line">                       <span class="comment">//创建一个用来覆盖水印的白色背景图片，大小要比水印稍大</span></div><div class="line">                       iTextSharp.text.Image image = iTextSharp.text.Image.GetInstance(<span class="keyword">new</span> Bitmap(<span class="number">400</span>, <span class="number">30</span>), BaseColor.WHITE);</div><div class="line">                       <span class="comment">//把图片放到水印的位置（IText使用的单位是pt而不是px，（0,0）坐标是PDF左下角！！）</span></div><div class="line">                       image.SetAbsolutePosition(Convert.ToInt16(<span class="number">70</span>), Convert.ToInt16(<span class="number">37</span>));</div><div class="line">                       <span class="comment">//添加图片到PDF的当前页</span></div><div class="line">                       stamper.GetOverContent(i).AddImage(image, <span class="literal">true</span>);</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="comment">//将MemoryStream输出到客户端浏览器</span></div><div class="line">               <span class="built_in">string</span> Disposition = <span class="string">""</span>;</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (OpenMode != null &amp;&amp; OpenMode.Length &gt; <span class="number">0</span>)</div><div class="line">                   Disposition = OpenMode + <span class="string">"; "</span>;</div><div class="line"></div><div class="line">               Disposition += ServerUtility.EncodeAttachmentFileName(context.Request.UserAgent, FileName);</div><div class="line"></div><div class="line">               context.Response.ContentType = ContentType;</div><div class="line">               context.Response.AppendHeader(<span class="string">"Content-Length"</span>, ExportResult.DataSize.ToString());</div><div class="line">               context.Response.AppendHeader(<span class="string">"Content-Disposition"</span>, Disposition);</div><div class="line">               context.Response.ClearContent();</div><div class="line">               object Data = ExportResult.SaveToVariant();</div><div class="line">               context.Response.BinaryWrite(outputPdfStream.ToArray());</div><div class="line">               context.Response.Flush();</div><div class="line">           &#125;</div><div class="line"></div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<h3 id="实现代码过程"><a href="#实现代码过程" class="headerlink" title="实现代码过程"></a>实现代码过程</h3><p>1、 网络上找到了简单实用iText操作PDF的代码，分为三块内容，第一块是创建空白PDF，第二块是创建水印，第三块去除水印。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">temp1</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="built_in">string</span> workingFolder = Environment.GetFolderPath(Environment.SpecialFolder.Desktop);</div><div class="line">        <span class="built_in">string</span> startFile = Path.Combine(workingFolder, <span class="string">"StartFile.pdf"</span>);</div><div class="line">        <span class="built_in">string</span> watermarkedFile = Path.Combine(workingFolder, <span class="string">"Watermarked.pdf"</span>);</div><div class="line">        <span class="built_in">string</span> unwatermarkedFile = Path.Combine(workingFolder, <span class="string">"Un-watermarked.pdf"</span>);</div><div class="line">        <span class="built_in">string</span> watermarkText = <span class="string">"This is a test"</span>;</div><div class="line"></div><div class="line">        <span class="comment">//watermarkedFile= @"E:\a\1.pdf";</span></div><div class="line">        <span class="comment">//SECTION 1</span></div><div class="line">        <span class="comment">//Create a 5 page PDF, nothing special here</span></div><div class="line">        <span class="keyword">using</span> (FileStream fs = <span class="keyword">new</span> FileStream(startFile, FileMode.Create, FileAccess.Write, FileShare.None))</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">using</span> (Document doc = <span class="keyword">new</span> Document(PageSize.LETTER))</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">using</span> (PdfWriter witier = PdfWriter.GetInstance(doc, fs))</div><div class="line">                &#123;</div><div class="line">                    doc.Open();</div><div class="line"></div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++)</div><div class="line">                    &#123;</div><div class="line">                        doc.NewPage();</div><div class="line">                        doc.Add(<span class="keyword">new</span> Paragraph(String.Format(<span class="string">"This is page &#123;0&#125;"</span>, i)));</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    doc.Close();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//SECTION 2</span></div><div class="line">        <span class="comment">//Create our watermark on a separate layer.The only different here is that we are adding the watermark to a PdfLayer which is an OCG or Optional Content Group</span></div><div class="line">        PdfReader reader1 = <span class="keyword">new</span> PdfReader(startFile);</div><div class="line">        <span class="keyword">using</span> (FileStream fs = <span class="keyword">new</span> FileStream(watermarkedFile, FileMode.Create, FileAccess.Write, FileShare.None))</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">using</span> (PdfStamper stamper = <span class="keyword">new</span> PdfStamper(reader1, fs))</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">int</span> pageCount1 = reader1.NumberOfPages;</div><div class="line">                <span class="comment">//Create a new layer</span></div><div class="line">                PdfLayer layer = <span class="keyword">new</span> PdfLayer(<span class="string">"WatermarkLayer"</span>, stamper.Writer);</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= pageCount1; i++)</div><div class="line">                &#123;</div><div class="line">                    iTextSharp.text.Rectangle rect = reader1.GetPageSize(i);</div><div class="line">                    <span class="comment">//Get the ContentByte object</span></div><div class="line">                    PdfContentByte cb = stamper.GetUnderContent(i);</div><div class="line">                    <span class="comment">//Tell the CB that the next commands should be "bound" to this new layer</span></div><div class="line">                    cb.BeginLayer(layer);</div><div class="line">                    cb.SetFontAndSize(BaseFont.CreateFont(BaseFont.HELVETICA, BaseFont.CP1252, BaseFont.NOT_EMBEDDED), <span class="number">50</span>);</div><div class="line">                    PdfGState gState = <span class="keyword">new</span> PdfGState();</div><div class="line">                    gState.FillOpacity = <span class="number">0.25f</span>;</div><div class="line">                    cb.SetGState(gState);</div><div class="line">                    cb.SetColorFill(BaseColor.BLACK);</div><div class="line">                    cb.BeginText();</div><div class="line">                    cb.ShowTextAligned(PdfContentByte.ALIGN_CENTER, watermarkText, rect.Width / <span class="number">2</span>, rect.Height / <span class="number">2</span>, <span class="number">45f</span>);</div><div class="line">                    cb.EndText();</div><div class="line">                    <span class="comment">//"Close" the layer</span></div><div class="line">                    cb.EndLayer();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//SECTION 3</span></div><div class="line">        <span class="comment">//Remove the layer created above</span></div><div class="line">        <span class="comment">//First we bind a reader to the watermarked file, then strip out a bunch of things, and finally use a simple stamper to write out the edited reader</span></div><div class="line">        PdfReader reader2 = <span class="keyword">new</span> PdfReader(watermarkedFile);</div><div class="line"></div><div class="line">        <span class="comment">//NOTE, This will destroy all layers in the document, only use if you don't have additional layers</span></div><div class="line">        <span class="comment">//Remove the OCG group completely from the document.</span></div><div class="line">        <span class="comment">//reader2.Catalog.Remove(PdfName.OCPROPERTIES);</span></div><div class="line"></div><div class="line">        <span class="comment">//Clean up the reader, optional</span></div><div class="line">        reader2.RemoveUnusedObjects();</div><div class="line"></div><div class="line">        <span class="comment">//Placeholder variables</span></div><div class="line">        PRStream stream;</div><div class="line">        String content;</div><div class="line">        PdfDictionary page;</div><div class="line">        PdfArray contentarray;</div><div class="line"></div><div class="line">        <span class="comment">//Get the page count</span></div><div class="line">        <span class="keyword">int</span> pageCount2 = reader2.NumberOfPages;</div><div class="line">        <span class="comment">//Loop through each page</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= pageCount2; i++)</div><div class="line">        &#123;</div><div class="line">            <span class="comment">//Get the page</span></div><div class="line">            page = reader2.GetPageN(i);</div><div class="line">            <span class="comment">//Get the raw content</span></div><div class="line">            contentarray = page.GetAsArray(PdfName.CONTENTS);</div><div class="line">            <span class="keyword">if</span> (contentarray != null)</div><div class="line">            &#123;</div><div class="line">                <span class="comment">//Loop through content</span></div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; contentarray.Size; j++)</div><div class="line">                &#123;</div><div class="line">                    <span class="comment">//Get the raw byte stream</span></div><div class="line">                    stream = (PRStream)contentarray.GetAsStream(j);</div><div class="line">                    <span class="comment">//Convert to a string. NOTE, you might need a different encoding here</span></div><div class="line">                    content = System.Text.Encoding.ASCII.GetString(PdfReader.GetStreamBytes(stream));</div><div class="line">                    <span class="comment">//Look for the OCG token in the stream as well as our watermarked text</span></div><div class="line">                    <span class="keyword">if</span> (content.IndexOf(<span class="string">"/OC"</span>) &gt;= <span class="number">0</span> &amp;&amp; content.IndexOf(watermarkText) &gt;= <span class="number">0</span>)</div><div class="line">                    &#123;</div><div class="line">                        <span class="comment">//Remove it by giving it zero length and zero data</span></div><div class="line">                        stream.Put(PdfName.LENGTH, <span class="keyword">new</span> PdfNumber(<span class="number">0</span>));</div><div class="line">                        stream.SetData(<span class="keyword">new</span> byte[<span class="number">0</span>]);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//Write the content out</span></div><div class="line">        <span class="keyword">using</span> (FileStream fs = <span class="keyword">new</span> FileStream(unwatermarkedFile, FileMode.Create, FileAccess.Write, FileShare.None))</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">using</span> (PdfStamper stamper = <span class="keyword">new</span> PdfStamper(reader2, fs))</div><div class="line">            &#123;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//this.Close();</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>2、由于水印位置固定且位于页脚处无其他内容，因此创建白色图片覆盖水印未知实现去除功能。<br>结合上面的代码和网上找到的相关实现进行修改后如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">temp2</span><span class="params">()</span></span></div><div class="line">       &#123;</div><div class="line">           <span class="built_in">string</span> watermarkedFile = @<span class="string">"E:\a\1out.pdf"</span>;</div><div class="line">           <span class="built_in">string</span> startFile = @<span class="string">"E:\a\1.pdf"</span>;</div><div class="line">           File.Delete(watermarkedFile);</div><div class="line">           PdfReader reader1 = <span class="keyword">new</span> PdfReader(startFile);</div><div class="line">           <span class="keyword">using</span> (FileStream fs = <span class="keyword">new</span> FileStream(watermarkedFile, FileMode.Create, FileAccess.Write, FileShare.None))</div><div class="line">           &#123;</div><div class="line">               <span class="keyword">using</span> (PdfStamper stamper = <span class="keyword">new</span> PdfStamper(reader1, fs))</div><div class="line">               &#123;</div><div class="line">                   <span class="keyword">int</span> pageCount1 = reader1.NumberOfPages;</div><div class="line">                   <span class="comment">//Create a new layer</span></div><div class="line">                   PdfLayer layer = <span class="keyword">new</span> PdfLayer(<span class="string">"WatermarkLayer"</span>, stamper.Writer);</div><div class="line">                   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= pageCount1; i++)</div><div class="line">                   &#123;</div><div class="line">                       PdfContentByte canvas = stamper.GetOverContent(i);</div><div class="line">                       canvas.SaveState();</div><div class="line">                       canvas.SetColorFill(BaseColor.RED);</div><div class="line">                       <span class="comment">//PdfGState gs = new PdfGState();</span></div><div class="line">                       <span class="comment">//gs.FillOpacity = 0.6f;//设置透明度</span></div><div class="line">                       <span class="comment">//canvas.SetGState(gs);</span></div><div class="line">                       <span class="comment">//PDF的左下角的坐标是（0,0），单位是pt</span></div><div class="line">                       canvas.Rectangle(<span class="number">70</span>, <span class="number">38</span>, <span class="number">400</span>, <span class="number">30</span>);</div><div class="line">                       canvas.Fill();</div><div class="line">                       canvas.RestoreState();</div><div class="line">                   &#125;</div><div class="line"></div><div class="line">                   stamper.Close();</div><div class="line">                   reader1.Close();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure></p>
<p>3、结合到实际的系统中(将有水印和无水印的两个PDF保存到本地，再以流方式传给客户端浏览器)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// &lt;summary&gt;</span></div><div class="line"><span class="comment">/// 将报表生成的二进制数据响应给 HTPP 请求客户端</span></div><div class="line"><span class="comment">/// &lt;/summary&gt;</span></div><div class="line"><span class="comment">/// &lt;param name="context"&gt; HTPP 请求对象&lt;/param&gt;</span></div><div class="line"><span class="comment">/// &lt;param name="ExportResult"&gt;报表生成的二进制数据&lt;/param&gt;</span></div><div class="line"><span class="comment">/// &lt;param name="FileName"&gt;指定下载(或保存)文件时的默认文件名称&lt;/param&gt;</span></div><div class="line"><span class="comment">/// &lt;param name="ContentType"&gt;响应的ContentType&lt;/param&gt;</span></div><div class="line"><span class="comment">/// &lt;param name="OpenMode"&gt;指定生成的数据打开模式，可选[inline|attachment]，"inline"表示在网页中内联显示，"attachment"表示以附件文件形式下载。如果不指定，由浏览器自动确定打开方式。&lt;/param&gt;</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ResponseBinaryPDF</span><span class="params">(HttpContextBase context, IGRBinaryObject ExportResult, <span class="built_in">string</span> FileName, <span class="built_in">string</span> ContentType, <span class="built_in">string</span> OpenMode)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="meta">#region 保存到本地pdf</span></div><div class="line"></div><div class="line">    <span class="built_in">string</span> newFileName = DirFileHelper.GetRamCode() + <span class="string">".pdf"</span>; <span class="comment">//随机生成新的文件名</span></div><div class="line">    <span class="built_in">string</span> upLoadPath = DirFileHelper.GetUpLoadPath(); <span class="comment">//保存目录相对路径</span></div><div class="line">    <span class="built_in">string</span> fullUpLoadPath = DirFileHelper.GetMapPath(upLoadPath); <span class="comment">//保存目录的物理路径</span></div><div class="line">    <span class="built_in">string</span> newFilePath = upLoadPath + newFileName; <span class="comment">//保存后的路径</span></div><div class="line"></div><div class="line">    <span class="comment">//检查保存的物理路径是否存在，不存在则创建</span></div><div class="line">    <span class="keyword">if</span> (!Directory.Exists(fullUpLoadPath))</div><div class="line">    &#123;</div><div class="line">        Directory.CreateDirectory(fullUpLoadPath);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//保存文件</span></div><div class="line">    ExportResult.SaveToFile(fullUpLoadPath + newFileName);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">#endregion</span></div><div class="line"></div><div class="line">    <span class="meta">#region 读取pdf去除水印</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="built_in">string</span> inputFilePath = fullUpLoadPath + newFileName;</div><div class="line">    <span class="built_in">string</span> outputFilePath = fullUpLoadPath + newFileName.Replace(<span class="string">".pdf"</span>, <span class="string">"_removed.pdf"</span>);<span class="comment">//去除水印后pdf</span></div><div class="line">    <span class="keyword">try</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">using</span> (Stream inputPdfStream = <span class="keyword">new</span> FileStream(inputFilePath, FileMode.Open, FileAccess.Read, FileShare.Read))</div><div class="line">        <span class="keyword">using</span> (Stream outputPdfStream = <span class="keyword">new</span> FileStream(outputFilePath, FileMode.Create, FileAccess.Write, FileShare.ReadWrite))</div><div class="line">        &#123;</div><div class="line">            <span class="comment">//Opens the unmodified PDF for reading</span></div><div class="line">            PdfReader reader = <span class="keyword">new</span> PdfReader(inputPdfStream);</div><div class="line">            <span class="comment">//Creates a stamper to put an image on the original pdf</span></div><div class="line">            PdfStamper stamper = <span class="keyword">new</span> PdfStamper(reader, outputPdfStream); <span class="comment">//&#123; FormFlattening = true, FreeTextFlattening = true &#125;;</span></div><div class="line"></div><div class="line">            <span class="keyword">int</span> pageCount = reader.NumberOfPages;</div><div class="line">            <span class="comment">////Create a new layer</span></div><div class="line">            <span class="comment">//PdfLayer layer = new PdfLayer("WatermarkLayer", stamper.Writer);</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= pageCount; i++)</div><div class="line">            &#123;</div><div class="line">                <span class="comment">//PdfContentByte canvas = stamper.GetUnderContent(i);</span></div><div class="line">                <span class="comment">//Creates an image that is the size i need to hide the text i'm interested in removing</span></div><div class="line">                iTextSharp.text.Image image = iTextSharp.text.Image.GetInstance(<span class="keyword">new</span> Bitmap(<span class="number">400</span>, <span class="number">30</span>), BaseColor.WHITE);</div><div class="line">                <span class="comment">//Sets the position that the image needs to be placed (ie the location of the text to be removed)</span></div><div class="line">                <span class="comment">//txtX.Text = 33,txtY.Text = 708 70, 38, 400, 30</span></div><div class="line">                image.SetAbsolutePosition(Convert.ToInt16(<span class="number">70</span>), Convert.ToInt16(<span class="number">37</span>));</div><div class="line">                <span class="comment">//Adds the image to the output pdf</span></div><div class="line">                stamper.GetOverContent(i).AddImage(image, <span class="literal">true</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line"></div><div class="line">            <span class="comment">//Creates the first copy of the outputted pdf</span></div><div class="line">            stamper.Close();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (Exception ex)</div><div class="line">    &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">#endregion</span></div><div class="line"></div><div class="line">    <span class="meta">#region 返回客户端浏览器PDF</span></div><div class="line">    <span class="comment">//以字符流的形式下载文件</span></div><div class="line">    <span class="keyword">using</span> (FileStream fs = <span class="keyword">new</span> FileStream(outputFilePath, FileMode.Open))</div><div class="line">    &#123;</div><div class="line">        byte[] bytes = <span class="keyword">new</span> byte[(<span class="keyword">int</span>)fs.Length];</div><div class="line">        fs.Read(bytes, <span class="number">0</span>, bytes.Length);</div><div class="line">        fs.Close();</div><div class="line">        <span class="built_in">string</span> Disposition = <span class="string">""</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (OpenMode != null &amp;&amp; OpenMode.Length &gt; <span class="number">0</span>)</div><div class="line">            Disposition = OpenMode + <span class="string">"; "</span>;</div><div class="line"></div><div class="line">        Disposition += ServerUtility.EncodeAttachmentFileName(context.Request.UserAgent, FileName);</div><div class="line"></div><div class="line">        context.Response.ContentType = ContentType;</div><div class="line">        context.Response.AppendHeader(<span class="string">"Content-Length"</span>, ExportResult.DataSize.ToString());</div><div class="line">        context.Response.AppendHeader(<span class="string">"Content-Disposition"</span>, Disposition);</div><div class="line"></div><div class="line">        context.Response.ClearContent();</div><div class="line">        object Data = ExportResult.SaveToVariant();</div><div class="line">        context.Response.BinaryWrite(bytes);</div><div class="line"></div><div class="line">        context.Response.Flush();</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">#endregion</span></div><div class="line"></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="网上相关资源与信息"><a href="#网上相关资源与信息" class="headerlink" title="网上相关资源与信息"></a>网上相关资源与信息</h2><p>1、 <a href="https://itextpdf.com/" target="_blank" rel="external">iText官网</a><br>2、 <a href="https://www.nuget.org/packages/iTextSharp/" target="_blank" rel="external">iText的NuGet地址</a><br>3、 <a href="http://www.it1352.com/245699.html" target="_blank" rel="external">How to convert pdfstamper to byte array</a><br>4、 <a href="http://stackoverflow.org.cn/front/ask/view?ask_id=236528" target="_blank" rel="external">PdfStamper获得字节数组</a><br>5、 <a href="http://www.runoob.com/w3cnote/px-pt-em-convert-table.html" target="_blank" rel="external">pt,px,em</a><br>6、 <a href="https://blog.csdn.net/sishenkankan/article/details/53107195" target="_blank" rel="external">使用itext直接替换PDF中的文本</a></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/05/30/枚举使用备忘/" rel="next" title="枚举使用备忘">
                <i class="fa fa-chevron-left"></i> 枚举使用备忘
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/06/19/insurance/" rel="prev" title="保险">
                保险 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zMjkxOC85NDc5"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="菜儿" />
          <p class="site-author-name" itemprop="name">菜儿</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">36</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/zuoluo11" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#问题描述"><span class="nav-number">1.</span> <span class="nav-text">问题描述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#收集网上信息"><span class="nav-number">2.</span> <span class="nav-text">收集网上信息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PDF操作插件-iText"><span class="nav-number">2.1.</span> <span class="nav-text">PDF操作插件 iText</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#代码"><span class="nav-number">3.</span> <span class="nav-text">代码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#最终实现代码"><span class="nav-number">3.1.</span> <span class="nav-text">最终实现代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实现代码过程"><span class="nav-number">3.2.</span> <span class="nav-text">实现代码过程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#网上相关资源与信息"><span class="nav-number">4.</span> <span class="nav-text">网上相关资源与信息</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">菜儿</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
